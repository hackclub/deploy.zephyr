#!/bin/sh
#
# Generated by /opt/zephyr/watcher

git show HEAD:entrypoint.sh
entrypoint_status=$?
if [ $entrypoint_status -eq 0 ]; then
    echo "entrypoint.sh found, running deployment..."

    git show HEAD:entrypoint.sh
    buildfile_status=$?
    if [ $buildfile_status -eq 0 ]; then
        echo "build.sh found, running build..."
        #   TODO: run build.sh
        echo "   ...done!"
    fi

    systemctl-exists() {
        [ $(systemctl list-unit-files "${1}*" | wc -l) -gt 3 ]
    }

    if [ systemctl-exists zephyrnet-{{site}}-deployment.service ]; then
        echo "no existing systemd service found, making a new one..."
        handlebars --site '{{site}}' < /etc/zephyr/watcher/systemd-template-unit.service.hbs > /etc/systemd/system/zephyrnet-{{site}}-deployment.service 
        echo "   ...systemd service created!"
        systemctl daemon-reload
        echo "   ...systemd daemon reloaded!"
        systemctl enable zephyrnet-{{site}}-deployment.service
        echo "   ...systemd service enabled!"
        systemctl start zephyrnet-{{site}}-deployment.service
        echo "   ...systemd service started!"
    else
        echo "systemd service restarting..."
        systemctl restart zephyrnet-{{site}}-deployment.service
        echo "   ...done!"
    fi
else
    echo "No entrypoint.sh file, skipping dynamic deploy"
fi
