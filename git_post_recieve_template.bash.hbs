#!/bin/bash
#
# Generated by /opt/zephyr/watcher

git show HEAD:build.sh 1>&2 2>/dev/null
buildfile_status=$?
if [ $buildfile_status -eq 0 ]; then
    echo "build.sh found, running build..."
    #   TODO: run build.sh
    echo "   ...done!"
fi

# To maintain our sanity, we're going to run all the services under orpheus
# instead of the pushing user
user='systemctluser'

git show HEAD:entrypoint.sh 1>&2 2>/dev/null
entrypoint_status=$?
if [ $entrypoint_status -eq 0 ]; then
    echo "entrypoint.sh found, running deployment..."


    port=$(egrep -lir "^{{site}}$" /opt/zephyr/watcher/ports | xargs basename 2>/dev/null)
    if [ -v $port ]; then
        echo "no port found for {{site}}, allocating one now..."
        port=$(node /opt/zephyr/watcher/port-entrypoint.js {{site}})
    else
        echo "port $port is already allocated to {{site}}"
    fi

    if [ -f /etc/systemd/system/zephyrnet-{{site}}-deployment.service ]; then
        echo "restarting zephyrnet-{{site}}-deployment.service..."
        sudo -u $user sudo systemctl restart zephyrnet-{{site}}-deployment.service
        echo "   ...done!"
    else
        echo "no existing systemd service found, initializing zephyrnet-{{site}}-deployment.service"
        handlebars --site '{{site}}' --port $port < /opt/zephyr/watcher/systemd-unit-template.service.hbs > /etc/systemd/system/zephyrnet-{{site}}-deployment.service
        echo "   ...systemd service created!"
        sudo -u $user sudo systemctl daemon-reload
        echo "   ...systemd daemon reloaded!"
        sudo -u $user sudo systemctl enable zephyrnet-{{site}}-deployment.service
        echo "   ...systemd service enabled!"
        sudo -u $user sudo systemctl start zephyrnet-{{site}}-deployment.service
        echo "   ...systemd service started!"
    fi
else
    echo "No entrypoint.sh file, skipping dynamic deploy"
fi
