#!/bin/sh
#
# Generated by /opt/zephyr/watcher

git show HEAD:build.sh 1>&2 2>/dev/null
buildfile_status=$?
if [ $buildfile_status -eq 0 ]; then
    echo "build.sh found, running build..."
    #   TODO: run build.sh
    echo "   ...done!"
fi

git show HEAD:entrypoint.sh 1>&2 2>/dev/null
entrypoint_status=$?
if [ $entrypoint_status -eq 0 ]; then
    echo "entrypoint.sh found, running deployment..."

    if [ -f /home/git/.config/systemd/user/zephyrnet-{{site}}-deployment.service ]; then
        echo "no existing systemd service found, initializing zephyrnet-{{site}}-deployment.service"
        handlebars --site '{{site}}' < /etc/zephyr/watcher/systemd-template-unit.service.hbs > /home/git/.config/systemd/user/zephyrnet-{{site}}-deployment.service
        echo "   ...systemd service created!"
        systemctl --user daemon-reload
        echo "   ...systemd daemon reloaded!"
        systemctl --user enable --start zephyrnet-{{site}}-deployment.service
        echo "   ...systemd service enabled!"
    else
        echo "restarting zephyrnet-{{site}}-deployment.service..."
        systemctl --user restart zephyrnet-{{site}}-deployment.service
        echo "   ...done!"
    fi
else
    echo "No entrypoint.sh file, skipping dynamic deploy"
fi
