#!/bin/bash
#
# Generated by /opt/zephyr/watcher

git show HEAD:build.sh 1>&2 2>/dev/null
buildfile_status=$?
if [ $buildfile_status -eq 0 ]; then
    echo "build.sh found, running build..."

    pushd /opt/zephyr/watcher/repos/{{site}}
    bash /opt/zephyr/watcher/repos/{{site}}/build.sh
    popd

    echo "   ...done!"
fi

# To maintain our sanity, we're going to run all the services under git
# instead of the pushing user
user='git'

git show HEAD:entrypoint.sh 1>&2 2>/dev/null
entrypoint_status=$?
if [ $entrypoint_status -eq 0 ]; then
    echo "entrypoint.sh found, running deployment for user $(whoami)..."

    port=$(egrep -lir "^{{site}}$" /opt/zephyr/watcher/ports | xargs basename 2>/dev/null)
    if [ -v $port ]; then
        echo "[info] no port found for {{site}}, assinging a new one..."
        port=$(node /opt/zephyr/watcher/port-entrypoint.js {{site}})
        echo "[info] $port was just assigned..."
    else
        echo "[info] $port is assigned to {{site}}"
    fi

    if [ -f ~/.config/systemd/user/zephyrnet-{{site}}-deployment.service ]; then
        echo "restarting zephyrnet-{{site}}-deployment.service..."
        systemctl --user daemon-reload
        systemctl --user restart zephyrnet-{{site}}-deployment.service
        echo "   ...done!"
    else
        echo "no existing systemd service found, initializing zephyrnet-{{site}}-deployment.service"
        node /opt/zephyr/watcher/deployment-hbs.js '{{site}}' $port >  ~/.config/systemd/user/zephyrnet-{{site}}-deployment.service
        echo "   ...systemd service created!"
        systemctl --user daemon-reload
        echo "   ...systemd daemon reloaded!"
        systemctl --user enable zephyrnet-{{site}}-deployment.service
        echo "   ...systemd service enabled!"
        systemctl --user start zephyrnet-{{site}}-deployment.service
        echo "   ...systemd service started!"
    fi
else
    echo "[info] No entrypoint.sh file, skipping deploy"
fi
