#!/bin/sh
#
# Generated by /opt/zephyr/watcher

git show HEAD:build.sh 1>&2 2>/dev/null
buildfile_status=$?
if [ $buildfile_status -eq 0 ]; then
    echo "build.sh found, running build..."
    #   TODO: run build.sh
    echo "   ...done!"
fi

# To maintain our sanity, we're going to run all the services under orpheus
# instead of the pushing user
user=`orpheus`

git show HEAD:entrypoint.sh 1>&2 2>/dev/null
entrypoint_status=$?
if [ $entrypoint_status -eq 0 ]; then
    echo "entrypoint.sh found, running deployment..."

    if [ -f /home/git/.config/systemd/user/zephyrnet-{{site}}-deployment.service ]; then
        echo "no existing systemd service found, initializing zephyrnet-{{site}}-deployment.service"
        handlebars --site '{{site}}' < /etc/zephyr/watcher/systemd-template-unit.service.hbs > /home/$user/.config/systemd/user/zephyrnet-{{site}}-deployment.service
        echo "   ...systemd service created!"
        su - $user -c 'systemctl --user daemon-reload'
        echo "   ...systemd daemon reloaded!"
        su - $user -c 'systemctl --user enable --start zephyrnet-{{site}}-deployment.service'
        echo "   ...systemd service enabled!"
    else
        echo "restarting zephyrnet-{{site}}-deployment.service..."
        su - $user -c 'systemctl --user restart zephyrnet-{{site}}-deployment.service'
        echo "   ...done!"
    fi
else
    echo "No entrypoint.sh file, skipping dynamic deploy"
fi
